<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Application</title>
</head>
<body>
    <input type="text" class="main">
    <button class="btn-prime">fetch</button>
    <div class="weather">
        <table class="tbl" style="padding: 20px;">
            <tr>
                <td id="temp"></td>
                <td class="img"></td>
            </tr>
        </table>
        <button class="toggle" style="display: none;">Toggle Scale</button>
    </div>
    <div class="recent">
        <h2>Recently Searched Locations</h2>
        <table class="recent-table">
            <tr>
                <td>Location</td>
                <td>Timestamp</td>
                <td>Weather</td>
            </tr>
        </table>
    </div>
</body>
<script>
    celsius = 0;
    tr_count = 1;
    document.querySelector('.btn-prime').onclick = function () {
        let xhr = new XMLHttpRequest();
        let access_key = "fecc9f824331849e23307ccc6fac6c85";
        // let query = document.querySelector('.main').value;
        let query = "new york"
        let units = 'm';
        xhr.open('GET', 'http://api.weatherstack.com/current?access_key=' 
        + access_key + '&query=' 
        + query + '&units='
        + units);

        xhr.send();

        xhr.onload = function() {
            if (xhr.status != 200) { // HTTP error?
                // handle error
                alert( 'Error: ' + xhr.status);
                return;
            }

            var resp = JSON.parse(xhr.response);
            // alert(resp["request"]);
            let prt = document.querySelector('.weather');
            var p = document.createElement("p");
            document.querySelector('.toggle').style.display = "block";
            td = document.querySelector('#temp');
            td.innerHTML = resp["current"]["temperature"] + " degree C";
            celsius = td.innerHTML;
            prt.appendChild(p);
            // var btn = document.createElement("button");
            // btn.class = "btn-degree";
            // btn.textContent = "Toggle Scale"
            // prt.appendChild(btn);
            td2 = document.querySelector('.img');
            var img = document.createElement("img");
            img.src = resp["current"]["weather_icons"][0];
            if(td2.hasChildNodes())
                td2.removeChild(td2.firstChild);    
            td2.appendChild(img);
            
            /* Recent table appending
                Below code creates new row inside the recent history table.
            */
            var rec_tab = document.querySelector('.recent-table'); // fetching recent table
            // Create tr and td elements
            var tr = document.createElement('tr');
            var td_loc = document.createElement('td');
            var td_time = document.createElement('td');
            var td_weath = document.createElement('td');
            // putting values inside td
            td_loc.innerText =  resp["location"]["name"];
            td_time.innerText = resp["location"]["localtime"];
            var desc = resp["current"]["weather_descriptions"];
            weath_text = "";
            for(i=0;i<desc.length;i++){
                weath_text += desc[i] + ' ';
            }
            td_weath.innerText = weath_text;
            // tr setting attribute
            tr.setAttribute('id', tr_count);
            tr_count += 1; // incrementing the row count by one.
            // tr appending
            rec_tab.appendChild(tr);
            // td setting attribute
            td_loc.setAttribute('id', 'td-1');
            td_time.setAttribute('id', 'td-2');
            td_weath.setAttribute('id', 'td-3');
            // td appending
            tr.appendChild(td_loc);
            tr.appendChild(td_time);
            tr.appendChild(td_weath);
        };
    };
    document.querySelector('.toggle').onclick = function(){
        td = document.querySelector('#temp').innerHTML;
        temp = td.split(' ')[0];
        final = "";
        if(td.split(' ')[2] == 'C'){
            temp_f = (9/5*parseInt(temp)) + 32;
            final = temp_f.toString() + ' ' + "degree F";
        }
        else{
            final = celsius;
        }
        document.querySelector('#temp').innerHTML = final;
    
    }
</script>
</html>